<!doctype html>
<html>

<head>
    <title>PrettySongTitle</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <style type="text/css">
        body {
            background-color: rgba(0, 0, 0, 0);
        }

        h4 {
            font-family:system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: white;
        }

        .fadeIn {
            animation: fadeInKeyFrames 1s linear forwards;
        }

        .fadeOut {
            animation: fadeOutKeyFrames 1s linear forwards;
        }

        .spin {
            transform: rotateY(0deg);
	        animation: spinFrames 2s linear forwards;
        }

        @keyframes fadeInKeyFrames {
            0%   { opacity : 0 }
            100% { opacity : 1 }
        }

        @keyframes fadeOutKeyFrames {
            0%   { opacity : 1 }
            100% { opacity : 0 }
        }

        @keyframes rotateFirstHalfFrames {
            from {transform: rotateY(0deg);}
            to {transform: rotateY(90deg);}
        }

        @keyframes rotateSecondHalfFrames {
            from {transform: rotateY(270deg);}
            to {transform: rotateY(360deg);}
        }

        @keyframes spinFrames {
            from {transform: rotateY(0deg);}
            to {transform: rotateY(360deg);}
        }

        .media {
            border-radius: 15px;
            background: rgba(0, 0, 0, .85);
            padding: 5px;
        }

        .text-overflow {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 500px;
        }

        .media-object {
            border-radius: 15px;
            padding: 5px;
        }
    </style>
</head>

<body>
    <div id="now-playing" class="fadeIn">
    </div>
    <script id="now-playing-template" type="text/x-handlebars-template">
        <div class="media">
            <div class="pull-left">
                <img class="media-object spin" width="64" src="{{item.album.images.2.url}}" />
            </div>
            <h4><b>Song:</b> {{item.name}}<b> | Album:</b> {{item.album.name }}<p><b>Artist(s):</b> {{artists}}</h4>
        </div>
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="./main.js"></script>
    <script>
        const DEFAULT_DURATION = 10 * 1000
        var stateKey = 'spotify_auth_state'
        var durationModifierInMs = 1000
        var duration = DEFAULT_DURATION
        var redirect_uri = 'http://localhost:8888/callback'
        var login_redirect_uri = 'http://localhost:8888'
        var access_token = ''
        var state = ''
        var storedState = ''
        var intervalId = undefined
        var lastSongTitle = undefined

        function getSong() {
            if (!!intervalId) {
                console.log('CALLBACK: Cleaning up interval...')
                window.clearInterval(intervalId)
            }

            console.log('CALLBACK: Getting the song')

            /**
             * Obtains parameters from the hash of the URL
             * @return Object
             */
            function getHashParams() {
                var hashParams = {}
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                    q = window.location.hash.substring(1)
                while (e = r.exec(q)) {
                    hashParams[e[1]] = decodeURIComponent(e[2])
                }
                return hashParams;
            }

            var nowPlayingSource = document.getElementById('now-playing-template').innerHTML,
                nowPlayingTemplate = Handlebars.compile(nowPlayingSource),
                nowPlayingPlaceholder = document.getElementById('now-playing')

            var params = getHashParams()

            access_token = (!!access_token) ? access_token : params.access_token
            state = (!!state) ? state : params.state
            storedState = (!!storedState) ? storedState : localStorage.getItem(stateKey)

            if (access_token && (state == null || state !== storedState)) {
                //alert('There was an error during the authentication');
                console.log('CALLBACK: auth issue - redirecting back to login page')
                window.location = login_redirect_uri
            } else {
                localStorage.removeItem(stateKey)
                if (access_token) {
                    $.ajax({
                        url: 'https://api.spotify.com/v1/me/player/currently-playing',
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function (response) {
                            if (!!response && !!response.is_playing) {
                                $('#now-playing').show()
                                jQuery('#now-playing').removeClass('fadeOut').addClass('fadeIn')
                                // Get the artist names if there are multiple.
                                let artists = ''
                                for (let i = 0; i < response.item.artists.length; i++) {
                                    if (response.item.artists.length > 1) {
                                        artists = `${artists}, ${response.item.artists[i].name}`
                                        artists = artists.slice(1)
                                    } else {
                                        artists = `${response.item.artists[i].name}`
                                    }
                                }

                                response.artists = artists
                                let msLeft = (response.item.duration_ms - response.progress_ms)
                                duration = (msLeft > DEFAULT_DURATION) ? DEFAULT_DURATION : msLeft + durationModifierInMs
                                console.log(`CALLBACK: Looks like it's going to be ${msLeft}ms until the song changes`)
                                if (response.item.name != lastSongTitle) {
                                    console.log(`CALLBACK: Refreshing template...`)
                                    nowPlayingPlaceholder.innerHTML = nowPlayingTemplate(response)
                                    lastSongTitle = response.item.name
                                } else {
                                    console.log(`CALLBACK: Skipping refresh...`)
                                }
                                intervalId = window.setInterval(() => { getSong() }, duration)
                            } else {
                                // what do we do here?
                                jQuery('#now-playing').removeClass('fadeIn').addClass('fadeOut')
                                intervalId = window.setInterval(() => { $('#now-playing').hide() }, 1000)
                                window.clearInterval(intervalId)

                                console.log(`CALLBACK: Nothing is playing, or the player is offline. Checking again in ${duration}ms.`)
                                intervalId = window.setInterval(() => { getSong() }, duration)
                            }

                        },
                        error: function (textStatus, errorThrown) {
                            console.log(`CALLBACK: Error: ${textStatus}\r\n${errorThrown}`)
                            // Probably a token refresh thing.
                            window.location = login_redirect_uri
                        }
                    });
                } else {
                    console.log('CALLBACK: No access token - redirecting back to login page')
                    window.location = login_redirect_uri
                }
            }
        }
        getSong()
    </script>

</html>