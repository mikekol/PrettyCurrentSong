<!doctype html>
<!-- Heavily based on the Spotify Implicit Grant example from https://github.com/spotify/web-api-auth-examples,
     though, we are not using the Implicit Grant model - we are, in fact, using Web Auth with PKCE. -->
<html>

<head>
    <title>PrettySongTitle</title>
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <style type="text/css">
        body {
            background-color: rgba(0, 0, 0, 0);
            overflow:hidden;
        }

        .fadeIn {
            animation: fadeInKeyFrames 1s linear forwards;
        }

        .fadeOut {
            animation: fadeOutKeyFrames 1s linear forwards;
        }

        .spin {
            transform: rotateY(0deg);
	        animation: spinFrames 2s linear forwards;
        }

        .media-object {
            border-radius: 15px;
            padding: 5px;
            width: 12vw;
        }

        .media {
            border-radius: 15px;
            background: rgba(0, 0, 0, .85);
            padding: 5px;
            display:block;
            margin-left: auto;
            margin-right: auto;
        }

        .info {
            font-family:system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: white;
            font-size:2.6rem;
            margin-top: 1.5vw;
        }

        @keyframes fadeInKeyFrames {
            0%   { opacity : 0 }
            100% { opacity : 1 }
        }

        @keyframes fadeOutKeyFrames {
            0%   { opacity : 1 }
            100% { opacity : 0 }
        }

        @keyframes rotateFirstHalfFrames {
            from { transform: rotateY(0deg);  }
            to   { transform: rotateY(90deg); }
        }

        @keyframes rotateSecondHalfFrames {
            from { transform: rotateY(270deg); }
            to   { transform: rotateY(360deg); }
        }

        @keyframes spinFrames {
            from { transform: rotateY(0deg);   }
            to   { transform: rotateY(360deg); }
        }
    </style>
</head>

<body>
    <div id="now-playing" class="fadeIn">
    </div>
    <script id="now-playing-template" type="text/x-handlebars-template">
        <div class="media text-overflow">
            <img class="media-object spin pull-left" src="{{item.album.images.2.url}}" />
            <div class="info">
                <b>Title:</b> {{item.name}} <b>| Album:</b> {{item.album.name}}<br>
                <b>Artist(s):</b> {{artists}}
            </div>
        </div>
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="./main.js"></script>
    <script>
        const DEFAULT_DURATION = 10 * 1000
        const TOKEN_TIME_THRESHOLD = 30 * 60 * 1000
        let durationModifierInMs = 1000
        let duration = DEFAULT_DURATION
        let songIntervalId = undefined
        let tokenIntervalId = undefined

        let lastSongTitle = undefined

        function getSong() {
            if (!!songIntervalId) {
                console.log('GETSONG: Cleaning up interval...')
                window.clearInterval(songIntervalId)
            }

            console.log('GETSONG: Getting the song')

            let nowPlayingSource = document.getElementById('now-playing-template').innerHTML,
                nowPlayingTemplate = Handlebars.compile(nowPlayingSource),
                nowPlayingPlaceholder = document.getElementById('now-playing')

            if (localStorage.getItem('access_token') ) {
                let tokenTimeRemaining = (localStorage.getItem('expires_at')) - Date.now()
                console.log(`GETSONG: token time ${tokenTimeRemaining}ms`)

                if (tokenTimeRemaining <= TOKEN_TIME_THRESHOLD) {
                    console.log(`GETSONG: Refreshing token...`)
                    refreshToken()
                }

                $.ajax({
                    url: 'https://api.spotify.com/v1/me/player/currently-playing',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                    },
                    success: function (response) {
                        if (!!response && !!response.is_playing) {
                            $('#now-playing').show()
                            jQuery('#now-playing').removeClass('fadeOut').addClass('fadeIn')
                            // Get the artist names if there are multiple.
                            let artists = ''
                            for (let i = 0; i < response.item.artists.length; i++) {
                                if (response.item.artists.length > 1) {
                                    artists = `${artists}, ${response.item.artists[i].name}`
                                    artists = artists.slice(1)
                                } else {
                                    artists = `${response.item.artists[i].name}`
                                }
                            }

                            response.artists = artists
                            let msLeft = (response.item.duration_ms - response.progress_ms)
                            duration = (msLeft > DEFAULT_DURATION) ? DEFAULT_DURATION : msLeft + durationModifierInMs
                            console.log(`GETSONG: Looks like it's going to be ${msLeft}ms until the song changes`)
                            if (response.item.name != lastSongTitle) {
                                console.log(`GETSONG: Refreshing template...`)
                                nowPlayingPlaceholder.innerHTML = nowPlayingTemplate(response)
                                lastSongTitle = response.item.name
                            } else {
                                console.log(`GETSONG: Skipping refresh...`)
                            }
                            songIntervalId = window.setInterval(() => { getSong() }, duration)
                        } else {
                            // what do we do here?
                            jQuery('#now-playing').removeClass('fadeIn').addClass('fadeOut')
                            songIntervalId = window.setInterval(() => { $('#now-playing').hide() }, 1000)
                            window.clearInterval(songIntervalId)

                            console.log(`GETSONG: Nothing is playing, or the player is offline. Checking again in ${duration}ms.`)
                            songIntervalId = window.setInterval(() => { getSong() }, duration)
                        }

                    },
                    error: function (textStatus, errorThrown) {
                        console.log(`GETSONG: Error: ${textStatus.statusText}\r\n${errorThrown}`)
                        // Probably a token refresh thing.

                    }
                });
            } else {
                console.log('GETSONG: No access token - trying to recover.')
                redirectToSpotifyAuthorizeEndpoint()
            }
        }
        getSong()
    </script>

</html>