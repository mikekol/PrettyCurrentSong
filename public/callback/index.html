<!doctype html>
<html>

<head>
    <title>PrettySongTitle</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <style type="text/css">
        body {
            background-color: rgba(0, 0, 0, 0);
        }

        h4 {
            color: white;
        }

        .media {
            border-radius: 15px;
            background: rgba(0, 0, 0, .85);
            padding: 5px;
        }

        .text-overflow {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 500px;
        }

        .media-object {
            border-radius: 15px;
            padding: 5px;
        }
    </style>
</head>

<body>
    <div id="now-playing">
    </div>
    <script id="now-playing-template" type="text/x-handlebars-template">
        <div class="media">
            <div class="pull-left">
                <img class="media-object" width="64" src="{{item.album.images.2.url}}" />
            </div>
            <h4><b>Song:</b> <i>{{item.name}}</i><b> | Album:</b> <i>{{item.album.name }}</i><p><b>Artist(s):</b> <i>{{artists}}</i></h4>
        </div>
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
        var stateKey = 'spotify_auth_state';
        var durationModifierInMs = 4000
        var duration = 10000
        var client_id = 'ec89600e478d4d8aa1a78e6a0a7e6097'; // Your client id
        var client_secret = 'c565f920374a4ecaac3103bcb0d42f4f'; // Your secret
        var redirect_uri = 'http://localhost:8888/callback'; // Your redirect uri
        var login_redirect_uri = 'http://localhost:8888';
        var access_token = ''
        var state = ''
        var storedState = ''
        var intervalId = undefined

        function getSong() {
            if (!!intervalId) {
                console.log('CALLBACK: Cleaning up interval...')
                window.clearInterval(intervalId)
            }

            console.log('CALLBACK: Getting the song')

            /**
             * Obtains parameters from the hash of the URL
             * @return Object
             */
            function getHashParams() {
                var hashParams = {};
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                    q = window.location.hash.substring(1);
                while (e = r.exec(q)) {
                    hashParams[e[1]] = decodeURIComponent(e[2]);
                }
                return hashParams;
            }

            var nowPlayingSource = document.getElementById('now-playing-template').innerHTML,
                nowPlayingTemplate = Handlebars.compile(nowPlayingSource),
                nowPlayingPlaceholder = document.getElementById('now-playing')

            var params = getHashParams();

            access_token = (!!access_token) ? access_token : params.access_token
            state = (!!state) ? state : params.state
            storedState = (!!storedState) ? storedState : localStorage.getItem(stateKey)

            if (access_token && (state == null || state !== storedState)) {
                //alert('There was an error during the authentication');
                console.log('CALLBACK: auth issue - redirecting back to login page')
                window.location = login_redirect_uri
            } else {
                localStorage.removeItem(stateKey);
                if (access_token) {
                    $.ajax({
                        url: 'https://api.spotify.com/v1/me/player/currently-playing',
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function (response) {
                            //userProfilePlaceholder.innerHTML = userProfileTemplate(response);
                            // Get the artist names if there are multiple.
                            let artists = ''
                            for (let i = 0; i < response.item.artists.length; i++) {
                                if (response.item.artists.length > 1) {
                                    artists = `${artists}, ${response.item.artists[i].name}`
                                    artists = artists.slice(1)
                                } else {
                                    artists = `${response.item.artists[i].name}`
                                }
                            }

                            response.artists = artists
                            duration = (response.item.duration_ms - response.progress_ms) + durationModifierInMs
                            console.log(`CALLBACK: Looks like it's going to be ${duration}ms until the song changes`)

                            nowPlayingPlaceholder.innerHTML = nowPlayingTemplate(response)
                            console.log(`CALLBACK: Last second duration check is ${duration}ms`)
                            intervalId = window.setInterval(() => { getSong() }, duration)
                        }
                    });
                } else {
                    console.log('CALLBACK: No access token - redirecting back to login page')
                    //window.location = login_redirect_uri
                }
            }
        }
        getSong()
    </script>

</html>